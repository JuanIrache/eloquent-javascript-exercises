<div></div>
<script>
  // The old draw tool. Rewrite this.
  function draw(pos, state, dispatch) {
    function drawPixel({ x, y }, state) {
      let drawn = { x, y, color: state.color };
      dispatch({ picture: state.picture.draw([drawn]) });
    }
    drawPixel(pos, state);
    return drawPixel;
  }

  function line(start, state, dispatch) {
    function drawLine(pos) {
      const distance = function(x1, y1, x2, y2) {
        const c1 = x2 - x1;
        const c2 = y2 - y1;
        return Math.sqrt(Math.pow(c1, 2) + Math.pow(c2, 2));
      };
      let drawn = [];
      let current = { x: start.x, y: start.y };
      while (current.x !== pos.x || current.y !== pos.y) {
        const startX = Math.max(0, current.x - 1);
        const startY = Math.max(0, current.y - 1);
        const endX = Math.min(current.x + 1, state.picture.width - 1);
        const endY = Math.min(current.y + 1, state.picture.height - 1);
        let best;
        let other = [];
        for (let y = startY; y <= endY; y++) {
          for (let x = startX; x <= endX; x++) {
            if (!best || distance(x, y, pos.x, pos.y) < best.dist) best = { x, y, dist: distance(x, y, pos.x, pos.y) };
            else other.push({ x, y });
          }
        }
        other.forEach(o => drawn.push({ x: o.x, y: o.y, color: 'red' }));
        drawn.push({ x: best.x, y: best.y, color: state.color });
        current = { x: best.x, y: best.y };
      }

      dispatch({ picture: state.picture.draw(drawn) });
    }
    drawLine(start);
    return drawLine;
  }

  let dom = startPixelEditor({
    tools: { draw, line, fill, rectangle, pick }
  });
  document.querySelector('div').appendChild(dom);
</script>
